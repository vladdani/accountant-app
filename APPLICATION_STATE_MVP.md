# Application State Documentation (MVP Baseline - Pre-RAG)

**Date:** 2025-04-16
**Commit Hash:** `cd1cc7e6c81bfb8a7f2302c5d16d26c6f430ab17`

**Restore Command:** `git checkout cd1cc7e6c81bfb8a7f2302c5d16d26c6f430ab1`

## Overview

This document describes the state of the CariNota application before the implementation of Retrieval-Augmented Generation (RAG) for semantic search. The application allows users to upload documents (invoices, quotes, etc.), have key metadata extracted via AI, store this information, and perform searches on the extracted metadata using an AI chat assistant.

## Key Components & File Structure

- **Framework:** Next.js 14+ (App Router)
- **UI:** React, Shadcn UI, Radix UI, Tailwind CSS
- **State Management:** React Hooks (`useState`, `useEffect`, `useCallback`), potentially React Context (`AuthContext`).
- **Core Logic:** Located primarily in `app/` (routing, pages, layouts) and `components/` (UI elements). Server-side logic is handled via Server Actions in `app/actions/`.
- **Routing:** Next.js App Router (`app/page.tsx` for landing, `app/dashboard/page.tsx` for main app).
- **Database Interaction:** Supabase client libraries (`@supabase/ssr` for server, `@supabase/supabase-js` potentially for client/admin). Client setup in `utils/supabase/`.
- **Types:** Database types generated by Supabase CLI likely stored in `types_db.ts`.
- **Configuration:** Environment variables stored in `.env.local` (e.g., Supabase keys, Google AI key).

## Database Schema (`documents` Table)

Based on `types_db.ts` and recent actions, the primary table is `public.documents`:

| Column               | Type          | Description                                                                                      |
| -------------------- | ------------- | ------------------------------------------------------------------------------------------------ |
| `id`                 | `uuid`        | Primary Key                                                                                      |
| `uploaded_by`        | `uuid`        | Foreign Key to `auth.users`, indicates owner                                                     |
| `file_path`          | `text`        | Path to the file in Supabase Storage (e.g., `user_id/.../file.pdf`)                              |
| `document_url`       | `text`        | Public URL of the file in Storage                                                                |
| `original_filename`  | `text`        | Original name of the uploaded file                                                               |
| `uploaded_at`        | `timestamp`   | Timestamp when the record was created                                                            |
| `content_hash`       | `text`        | SHA-256 hash of the file content (used for duplicate detection)                                  |
| `vendor`             | `text`        | Extracted Vendor/Supplier name (via AI)                                                          |
| `document_date`      | `date`        | Extracted primary date from document (via AI, stored as YYYY-MM-DD)                              |
| `document_type`      | `text`        | Extracted document classification (e.g., 'invoice', 'quote', via AI)                             |
| `total_amount`       | `numeric`     | Extracted total amount (via AI)                                                                  |
| `currency`           | `text`        | Extracted currency code (e.g., 'IDR', 'USD', via AI, defaults to 'IDR')                          |
| `description`        | `text`        | Extracted brief summary/description (via AI)                                                     |
| `discount`           | `numeric`     | Extracted discount amount (via AI)                                                               |
| `processing_time_ms` | `numeric`     | Time taken for the `uploadFile` action to process (including AI)                                 |
| `content`            | `text`        | Potentially stores extracted text content (Added in type defs, needs confirmation on population) |
| `content_tokens`     | `numeric`     | Potentially stores token count (Added in type defs, needs confirmation)                          |
| `embedding`          | `vector(768)` | Added via ALTER TABLE, but not yet populated or used in this commit state.                       |

_(Note: `content`, `content_tokens` require confirmation if they are actively populated by the upload process at this stage. `embedding` column exists but is unused)._

## Core Functionality Flows

### 1. Document Upload & Initial Extraction

1.  **Trigger:** User uploads file via UI (likely `app/dashboard/page.tsx`).
2.  **Action:** `app/actions/upload-file.ts` (`uploadFile` function) is called.
3.  **Steps within `uploadFile`:**
    - Authenticates user using `utils/supabase/server` client.
    - Calculates SHA-256 hash of the file content.
    - Checks `documents` table for duplicates based on `uploaded_by` and `content_hash`.
    - Uploads file buffer to Supabase Storage (`documents` bucket) using Admin client.
    - Gets public URL.
    - Inserts initial row into `documents` table with file info, hash, and `null` for extracted fields.
    - Calls Google Generative AI (`gemini-1.5-flash-latest`) with the file content (as base64) and a detailed prompt asking for `vendor`, `date`, `type`, `amount`, `currency`, `description`, `discount`. The prompt instructs the AI to consider the filename for `type` classification.
    - Parses the JSON response from the AI.
    - Updates the `documents` row with the extracted metadata.
    - Updates the `processing_time_ms`.
4.  **UI Update:** `app/dashboard/page.tsx` uses Supabase Realtime subscription on the `documents` table (filtered by the `processingDocId` state) to listen for the `UPDATE` event after AI extraction. Upon receiving the update, it refreshes the document list (`fetchDocuments`, `fetchTypes`, `fetchDocumentCount`).

### 2. AI Chat Search (Structured Metadata)

1.  **Trigger:** User types query into chat interface (`app/dashboard/page.tsx`).
2.  **Action:** `app/actions/handle-user-search-query.ts` (`handleUserSearchQueryAction`) is called.
3.  **Steps within `handleUserSearchQueryAction`:**
    - Authenticates user.
    - Constructs initial message history (system prompt, chat history, user query).
    - Calls Google Generative AI (`gemini-2.0-flash`) with messages and the `query_documents` tool definition.
    - **Tool Definition (`query_documents`):**
      - Defined using `ai/core`'s `tool()`.
      - Parameters: `vendor`, `document_type`, `start_date`, `end_date`, `min_amount`, `max_amount`, `currency`.
      - Parameter descriptions guide the AI on flexible type matching and date range interpretation (e.g., "in 2024").
    - **Tool Call Handling:**
      - If AI response indicates `finishReason: 'tool-calls'` for `query_documents`:
        - Logs raw and validated arguments from AI.
        - Calls `app/actions/query-structured-documents.ts` (`queryStructuredDocumentsAction`) with validated args.
        - `queryStructuredDocumentsAction` builds and executes a Supabase query against the `documents` table using the provided metadata filters (`ilike` for vendor, `eq` for type, `gte`/`lte` for dates/amounts, filtered by `uploaded_by`). It selects all extracted metadata fields (excluding `embedding`, `content`).
        - Returns results (as JSON string) or "not found" / error message.
      - Appends assistant message (with tool call details) and tool result message to history.
      - Calls `generateText` again with updated history.
    - **Final Response:** When AI `finishReason` is `stop`, returns the AI's final text response to the UI.

## External Services & Dependencies

- **Supabase:** Database (Postgres w/ pgvector), Authentication, Storage.
- **Google Cloud / Vertex AI:** Gemini models (`gemini-1.5-flash-latest` for extraction, `gemini-2.0-flash` for chat search). Requires `GOOGLE_GENERATIVE_AI_API_KEY`.
- **Vercel:** Hosting, Serverless Functions / Edge Functions (potentially for backend), Analytics, Speed Insights.
- **Stripe:** Used for Subscription/Billing (mentioned in pricing plans).
- **Key Libraries:** `@supabase/ssr`, `@supabase/supabase-js`, `@ai-sdk/google`, `ai`, `zod`, `geist`, `framer-motion`, `lucide-react`, `@vercel/analytics`, `@vercel/speed-insights`.

## Current Known Limitations / Assumptions

- Search functionality relies solely on the accuracy of the initial AI metadata extraction stored in the database. It does not re-analyze document content during search.
- The quality of search results depends heavily on the AI's ability to correctly interpret the user query and map it to the available structured filters and the accuracy of the initial data extraction.
- The `content` and `content_tokens` columns exist in type definitions but their population/use needs confirmation.
- The `embedding` column exists but is not populated or used for search in this version.
