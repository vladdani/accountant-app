# Backend & Database Setup Documentation (Pre-Search API)

This document outlines the state of the backend document processing pipeline and database configuration established _before_ the implementation of the semantic search API route (`/app/api/query-documents`).

---

**1. Supabase Edge Function: `process-document`**

- **Location:** `supabase/functions/process-document/index.ts`
- **Purpose:** Automatically process documents shortly after they are recorded in the database. Triggered by a database event (see Database section below).
- **Core Logic:**
  1.  **Payload Validation:** Expects a payload from a Database Trigger on the `public.documents` table, specifically looking for `type: 'INSERT'`, `table: 'documents'`, and `record.file_path`.
  2.  **File Download:** Uses an admin Supabase client (`createClient` with `SERVICE_ROLE_KEY`) to download the file specified by `record.file_path` from the `documents` Supabase Storage bucket.
  3.  **Content Extraction:**
      - **PDFs:** Uses `pdfjs-dist` (imported via `import_map.json`) to parse the downloaded PDF file buffer (`ArrayBuffer`) and extract text content.
      - **Images (jpeg, png, etc.):** Converts the image file buffer to Base64 using Deno's standard library (`encode` from `deno.land/std/encoding/base64.ts`). This Base64 string is then prepared for the Gemini Vision model.
  4.  **Structured Data Extraction (Gemini):**
      - Uses the `gemini-2.0-flash-lite` model via the `@google/generative-ai` library.
      - Sends either the extracted text (from PDFs) or the Base64 image data to the model.
      - Utilizes a detailed prompt designed to extract specific fields (date, due_date, amount, currency, supplier, document_number, item, line_items, type) and agreement-specific details (parties, subject, payment terms) if the document type is identified as 'agreement'. The prompt includes mappings for common Indonesian document names (e.g., 'Faktur Penjualan' -> 'invoice').
      - The result is expected as a JSON object.
  5.  **Embedding Generation (Gemini):**
      - Uses the `text-embedding-004` model via the `@google/generative-ai` library.
      - Generates a 768-dimension vector embedding based on the extracted text (for PDFs) or a summary string created from the extracted data (for images).
  6.  **Database Update:** Uses the admin Supabase client to update the corresponding row in the `public.documents` table (identified by the `id` from the trigger payload's `record`). It saves the extracted JSON data to the `extracted_data` column (JSONB) and the generated vector to the `embedding` column (`vector(768)`).
- **Dependencies (via `import_map.json`):**
  - `@supabase/supabase-js`
  - `@google/generative-ai`
  - `pdfjs-dist` (including legacy `pdf.mjs` and `pdf.worker.mjs`)
  - Deno Standard Library modules (`http/server.ts`, `encoding/base64.ts`)
- **Configuration Files:**
  - `supabase/functions/process-document/deno.json`: Specifies Deno compiler options (`target: es2018`, `lib: ["deno.ns", "es2018"]`).
  - `supabase/functions/process-document/import_map.json`: Maps dependency names/URLs for Deno resolution.
- **Environment Variables (Required in Supabase Function Settings):**
  - `PROJECT_URL`: Your Supabase project URL.
  - `SERVICE_ROLE_KEY`: Your Supabase service role key (for admin client).
  - `GEMINI_API_KEY`: Your API key for Google Gemini services.

**2. Database Setup (Supabase PostgreSQL)**

- **`pgvector` Extension:** Enabled on the Supabase project to handle vector data types and similarity searches.
- **`documents` Table (Simplified Schema):**
  - `id` (uuid, primary key)
  - `file_path` (text): Path to the file within the Supabase Storage bucket (e.g., `user_id/year/month/filename.pdf`). Used by the Edge Function trigger.
  - `document_url` (text): Public URL to access the file in storage.
  - `uploaded_at` (timestamp): Timestamp of the record insertion.
  - `uploaded_by` (uuid): Foreign key to `auth.users`.
  - `extracted_data` (jsonb): Stores the structured data extracted by Gemini.
  - `embedding` (vector(768)): Stores the 768-dimension embedding generated by `text-embedding-004`. **Crucially, the dimension (768) must match the embedding model used.**
- **Database Trigger:** A trigger is configured on the `public.documents` table. On `INSERT` events, this trigger invokes the `process-document` Edge Function via an HTTP POST request, sending the row data (`record`) in the payload. (This is how the function knows which file to process).
- **Vector Index (Optional but Recommended):** For efficient semantic search, creating an index on the `embedding` column using `USING ivfflat` or `USING hnsw` is highly recommended. The SQL for this was provided previously but might not have been executed yet.

**3. Editor Configuration**

- **`.vscode/settings.json`:** Created to help VS Code recognize the Deno runtime environment for the Edge Function, enabling proper linting and type checking for Deno-specific APIs and URL imports within `index.ts`.

---
